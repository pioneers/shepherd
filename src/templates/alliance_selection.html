{% extends 'base.html' %}
{% block head_content %}
<title>Alliance Selection</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Comic Sans MS, Comic Sans, cursive;
  }

  .container {
    display: block;
  }

  .inner-container {
    display: flex;
    height: auto;
    width: auto;
    flex-direction: row;
    justify-content: space-between;
  }


  .left-container,
  .right-container {
    display: block;
    flex-direction: column;
    width: 40%;
    height: 70vh;
    padding: 10px;
    border: 1px solid black;
    background-color: #F5F5F5;
    overflow-y: auto;
  }


  .alliance {
    display: flex;
    flex-direction: row;
    background-color: goldenrod;
    border: 1px solid black;
    height: 40%;
    border-radius: 10px;
    margin: 5px;
    justify-content: center;
    align-items: center;
    padding: 0%;
  }

  .alliance-num {
    display: flex;
    flex-direction: row;
    background-color: white;
    width: 15%;
    height: 25%;
    border: 1px solid black;
    margin: 5px 5px 5px 5px;
    border-radius: 10px;
    justify-content: center;
    align-items: center;
  }

  .alliance-drop-area {
    background-color: white;
    height: 90%;
    width: 70%;
    margin: 5px 5px 5px 5px;
    border: 1px solid black;
    border-radius: 10px;
  }

  .team {
    display: flex;
    flex-direction: row;
    background-color: green;
    border: 1px solid black;
    border-radius: 10px;
    height: 100px;
    width: 100%;
  }

  .name {
    display: flex;
    flex-direction: row;
    background-color: blue;
    width: 70%;
    height: 90%;
    border: 1px solid black;
    margin: 5px 5px 5px 5px;
    border-radius: 10px;
    justify-content: center;
    align-items: center;
  }

  .record {
    display: flex;
    flex-direction: row;
    background-color: blue;
    width: 25%;
    height: 90%;
    border: 1px solid black;
    margin: 5px 5px 5px 5px;
    border-radius: 10px;
    justify-content: center;
    align-items: center;
  }
</style>

<script>
  // this function is called when the page is loaded, from base.html
  // socket: the main socketio websocket
  // send: a function that sends a header through the socket, and also logs it


  /* The schools to add to this year's competition */
  let schools = ["Middle College", "Pinole Valley", "Oakland Tech", 
    "Bishop O'Dowd", "El Cerrito", "Coliseum", "Live Oak", "ASTI", 
    "LPS Richmond", "Albany", "Hayward", "ACLC", "ARISE", "Salesian",
     "Hercules", "Skyline", "San Leandro"].sort();

  /* We create a div element and add it to right-container for each
  schools participating in this year's competition
   */
  function addSchools() {
    //the right-container div
    const parent1 = document.getElementsByClassName("right-container")[0];
    for (var school of schools) {
      //this is the container that stores the school name and score
      var container = document.createElement("div")
      container.classList.add("row", "rounded", "m-2", "p-2", "bg-primary", "text-center", "draggable");
      container.setAttribute("draggable", "true");
      container.style.justifyContent = "space-evenly";

      //div for school and score
      var newDivSchool = document.createElement("div")
      newDivSchool.classList.add("col-md-8", "bg-light", "rounded");
      var newDivScore = document.createElement("div")
      newDivScore.classList.add("col-md-3", "bg-warning", "rounded");

      var newSchool = document.createTextNode(school);
      var divScore = document.createTextNode("0:3");

      newDivSchool.appendChild(newSchool);
      newDivScore.appendChild(divScore);

      container.appendChild(newDivSchool);
      container.appendChild(newDivScore);
      //add the div to the right-container
      parent1.appendChild(container);
    }
  }

  /* Function to make the teamDivs in the left container */
  function makeTeamDivs() {
    var innerContainer = document.getElementsByClassName("inner-container")[0]
    var leftContainer = innerContainer.getElementsByClassName("left-container")[0];
    var numSchools = schools.length % 3 == 0 ? schools.length: schools.length + 1;
    //create a yellow container for num_schools/2 alliances
    for (let i= 0; i < numSchools/2; i++) {
      // Create the outer div element with the class "alliance"
      var allianceDiv = document.createElement("div");
      allianceDiv.classList.add("alliance");
        
      // Create the inner div element with the class "alliance-num"
      const allianceNumDiv = document.createElement("div");
      allianceNumDiv.classList.add("alliance-num");
      // Create the span element and set its text content to "i + 1"
      const spanElement = document.createElement("span");
      spanElement.textContent = i + 1;

      // Append the span element to the inner div
      allianceNumDiv.appendChild(spanElement);

      // Create the inner div element with the classes "alliance-drop-area" and "drop-here"
      const allianceDropAreaDiv = document.createElement("div");
      allianceDropAreaDiv.classList.add("alliance-drop-area", "drop-here");

      // Append the inner divs to the outer div
      allianceDiv.appendChild(allianceNumDiv);
      allianceDiv.appendChild(allianceDropAreaDiv);
      leftContainer.appendChild(allianceDiv);
    }
  }

  function main_js_content(socket, send) {


    function saveStateOfAlliance() {
      localStorage.setItem("alliances", document.getElementById("inner-container").innerHTML);
    }

    function loadStateOfAlliance() {
      if (localStorage.getItem("alliances")) {
        document.getElementById("inner-container").innerHTML = localStorage.getItem("alliances");
      } else {
        console.log("No key found");
      }

    }

    function clearSelection() {
      if (localStorage.getItem("alliances")) {
        localStorage.removeItem("alliances");
        location.reload();
      }
    }
    document.getElementById("clear").addEventListener("click", clearSelection);

    // on reload this is called 
    loadStateOfAlliance();
    addSchools();
    makeTeamDivs();


    const draggables = document.querySelectorAll('.draggable')
    const containers = document.querySelectorAll('.drop-here')







    draggables.forEach(draggable => {
      draggable.addEventListener('dragstart', () => {
        draggable.classList.add('dragging')
      })

      draggable.addEventListener('dragend', () => {
        draggable.classList.remove('dragging');
        saveStateOfAlliance();
      })
    })



    containers.forEach(container => {
      container.addEventListener('dragover', e => {
        e.preventDefault()
        const afterElement = getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.dragging');
        if (afterElement == null) {
          container.appendChild(draggable);
        } else {
          container.insertBefore(draggable, afterElement);
        }

      })

    })

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')]

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect()
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return {
            offset: offset,
            element: child
          }
        } else {
          return closest;
        }
      }, {
        offset: Number.NEGATIVE_INFINITY
      }).element
    }
  }
</script>
{% endblock %}
{% block html_content %}
<div class="m-4" style="display: flex; flex-direction: row; align-items: center; justify-content: center;">
  <img style="margin-right: 2rem;" height="100px" src="../static/logo-border-20px-v3.png" alt="Pie Logo">
  <h1 style="font-size: 40px;">
    Alliance Selection
  </h1>
</div>

<button type="button" class="btn btn-primary my-2" id="sync">Sync Spreadsheet</button>

<!-- Since there is nothing in place yet for saving the changes this could just reload page -->

<button type="button" class="btn btn-primary my-2" id="clear">Clear Selections</button>

<div class="inner-container" id="inner-container">
  <div class="left-container">

    <!-- <div class="alliance">
      <div class="alliance-num">
        <span>
          1
        </span>

      </div>
      <div class="alliance-drop-area drop-here">
      </div>
    </div> -->

    <!-- <div class="alliance">
      <div class="alliance-num">
        <span>
          2
        </span>

      </div>
      <div class="alliance-drop-area drop-here">
      </div>
    </div>

    <div class="alliance">
      <div class="alliance-num">
        <span>
          3
        </span>

      </div>
      <div class="alliance-drop-area drop-here">
      </div>
    </div>

    <div class="alliance">
      <div class="alliance-num">
        <span>
          4
        </span>

      </div>
      <div class="alliance-drop-area drop-here">
      </div>
    </div> -->
  </div>





<!-- the addSchools function will add all schools participating in this container -->
<div class="right-container drop-here">
</div>

<!-- 
<div class="right-container drop-here">
    <div class="row rounded m-2 p-2 bg-primary text-center draggable" draggable="true"
      style="justify-content: space-evenly;" id="SanMateo">
      <div class="col-md-8 bg-light rounded">
        San Mateo
      </div>
      <div class="col-md-3 bg-warning rounded">
        0:3
      </div>
    </div>

    <div class="row rounded m-2 p-2 bg-primary text-center draggable" draggable="true"
      style="justify-content: space-evenly;">
      <div class="col-md-8 bg-light rounded">
        Berkeley
      </div>
      <div class="col-md-3 bg-warning rounded">
        0:3
      </div>
    </div>

    <div class="row rounded m-2 p-2 bg-primary text-center draggable" draggable="true"
      style="justify-content: space-evenly;">
      <div class="col-md-8 bg-light rounded">
        Stanford
      </div>
      <div class="col-md-3 bg-warning rounded">
        0:3
      </div>
    </div>

    <div class="row rounded m-2 p-2 bg-primary text-center draggable" draggable="true"
      style="justify-content: space-evenly;">
      <div class="col-md-8 bg-light rounded">
        Subway
      </div>
      <div class="col-md-3 bg-warning rounded">
        0:3
      </div>
    </div>
  </div>  -->



</div>
{% endblock %}